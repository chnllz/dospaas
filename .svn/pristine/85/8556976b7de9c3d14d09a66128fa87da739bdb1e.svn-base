<template>
  <a-drawer
    height="100%"
    placement="top"
    :closable="false"
    :destroyOnClose="true"
    :visible="show"
    @close="show = !show"
  >
    <iframe :src="pageUrl" width="100%" height="100%" frameborder="0" scrolling="no" allow="payment"></iframe>
    <a-modal v-model="visible" :title="$t('æ·»åŠ å†å²ç‰ˆæœ¬')" @ok="handleSubmit">
      <a-form :form="form">
        <a-form-item :labelCol="labelCol" :wrapperCol="wrapperCol" :label="$t('ç‰ˆæœ¬å·')">
          <a-input v-decorator="['version', { rules: [{ required: true, message: $t('è¯·å¡«å†™ç‰ˆæœ¬å·') }] }]"></a-input>
        </a-form-item>
        <a-form-item :labelCol="labelCol" :wrapperCol="wrapperCol" :label="$t('å¤‡æ³¨')">
          <a-textarea v-decorator="['remarks']" />
        </a-form-item>
      </a-form>
    </a-modal>
    <a-modal v-model="visibleHistory" :title="$t('æŸ¥çœ‹å†å²ç‰ˆæœ¬')" @ok="handleSubmit">
      <!-- <s-table
        ref="table"
        size="small"
        rowKey="id"
        :columns="columns"
        :data="loadDataTable"
        :sorter="{ field: 'id', order: 'descend' }"
      >
        <div slot="action" slot-scope="text, record">
          <a @click="rollback(record)">
            {{ $t('æ¢å¤è‡³æ­¤ç‰ˆæœ¬') }}
          </a>
        </div>
      </s-table> -->
    </a-modal>
    <flow-attr ref="FlowAttr" :workflowId="workflowId" :flowData="flowData" :select="currentSelect" @ok="handleOk" />
  </a-drawer>
</template>
<script>
export default {
  components: {
    FlowAttr: () => import('./modules/FlowAttr')
  },
  data () {
    return {
      pageUrl: process.env.VUE_APP_BASE_URL + 'webapp/index.html',
      visible: false,
      visibleHistory: false,
      graph: null,
      id: 0,
      name: '',
      labelCol: { span: 4 },
      wrapperCol: { span: 20 },
      cell: {},
      flowData: { params: { tableId: '07b66955d18b4dd286d2fdacb2dc4e71' } },
      currentSelect: { type: null, id: this.id, nodeName: this.name },
      data: {},
      target: {},
      form: this.$form.createForm(this),
      show: false, // iframeçš„å±•ç¤º
      lock: false, // æ˜¯å¦è¢«é”
      lockId: null,
      keepLock: null, // ä¿æŒç¼–è¾‘é”çš„å‡½æ•°
      columns: [{
        title: this.$t('æ“ä½œ'),
        dataIndex: 'action',
        align: 'center',
        width: 80,
        scopedSlots: { customRender: 'action' }
      },
      {
        title: this.$t('ç‰ˆæœ¬åç§°'),
        dataIndex: 'version',
        align: 'center',
        width: 80
      },
      {
        title: this.$t('å‘å¸ƒäºº'),
        dataIndex: 'updateUser',
        align: 'center',
        width: 100
      },
      {
        title: this.$t('å‘å¸ƒæ—¶é—´'),
        dataIndex: 'updateTime',
        align: 'center',
        width: 120
      },
      {
        title: this.$t('å¤‡æ³¨'),
        dataIndex: 'remarks',
        align: 'center',
        width: 150
      }],
      workflowId: null
    }
  },
  loadDataTable () {

  },
  created () {
    window.onbeforeunload = () => {
      this.axios({
        url: '/admin/workflow/unlock',
        data: {
          lockId: this.lockId,
          workflowId: this.workflowId
        }
      })
    }
    window.top['drawio'] = {}
    // è½½å…¥è§†å›¾ä¿¡æ¯
    window.top['drawio']['fileInit'] = () => {
      return {
        title: this.data.workflowName,
        data: this.data.flow
      }
    }
    // æŸ¥çœ‹å†å²ç‰ˆæœ¬
    window.top['drawio']['showHistory'] = () => {
      this.visibleHistory = !this.visibleHistory
    }
    // ä¿å­˜ä¸ºå†å²ç‰ˆæœ¬
    window.top['drawio']['saveHistory'] = () => {
      this.visible = !this.visible
    }
    // ä¿å­˜ä¿®æ”¹
    window.top['drawio']['save'] = (res) => {
      this.onSave(res)
    }
    // é€€å‡ºdrawio
    window.top['drawio']['exit'] = () => {
      const that = this
      this.$confirm({
        title: this.$t('æ‚¨ç¡®è®¤è¦é€€å‡ºå—ï¼Ÿ'),
        onOk () {
          that.show = false
          if (that.lock) {
            that.lock = false
            return
          }
          // é€€å‡ºä¹‹åè¦æ¸…é™¤æ¯éš”ä¸€åˆ†é’Ÿå°±å‘é€ä¸€æ¬¡çš„ç¼–è¾‘é”
          clearInterval(that.keepLock)
          that.axios({
            url: '/admin/workflow/unlock',
            data: {
              lockId: that.lockId,
              workflowId: that.workflowId
            }
          })
        }
      })
    }

    // æç¤ºé”™è¯¯ä¿¡æ¯
    window.top['drawio']['error'] = (res) => {
      res = res.slice(0, res.length - 1) + 'ã€‚'
      this.$error({
        title: this.$t(res),
        onOk () {
        }
      })
    }
    // åˆ é™¤èŠ‚ç‚¹ä¿¡æ¯
    window.top['drawio']['delete'] = (res) => {
      if (this.lock) {
        this.$message.warning('ç¼–è¾‘é”å·²å¯ç”¨ï¼Œæ‚¨ä¸èƒ½æäº¤æ•°æ®')
        return
      }
      this.axios({
        url: 'admin/data/delete',
        data: {
          tableName: 'admin_w_workflow_node',
          where: {
            fieldName: 'node_id',
            fieldValue: res
          }
        }
      })
    }
    // åŒå‡»æ‰“å¼€å›¾å½¢ç¼–è¾‘
    window.top['drawio']['open'] = (cell, graph) => {
      this.currentSelect = {}
      this.graph = graph
      this.cell = cell
      // ç»™å›¾å½¢åˆ†ç±»
      const type = () => {
        if (this.cell.style.indexOf('fillColor=#d9d9d9') !== -1) {
          return 'quote_transition'
        }
        if (this.cell.style.indexOf('user_transition') !== -1) return 'user_transition'
        if (this.cell.style.indexOf('start') !== -1) return 'start'
        if (this.cell.style.indexOf('end') !== -1) return 'end'
        if (this.cell.style.indexOf('gateway_andsplit') !== -1) return 'gateway_andsplit'
        if (this.cell.style.indexOf('gateway_andjoin') !== -1) return 'gateway_andjoin'
        if (this.cell.style.indexOf('gateway_implicit') !== -1) return 'gateway_implicit'
        if (this.cell.style.indexOf('gateway_orjoin') !== -1) return 'gateway_orjoin'
        if (this.cell.style.indexOf('gateway_explicit') !== -1) return 'gateway_explicit'
        if (this.cell.style.indexOf('edge') !== -1) {
          this.target = cell.target
          return 'link'
        }
      }
      this.name = cell.value
      this.id = cell.id
      this.currentSelect.id = cell.id
      this.currentSelect.type = cell.type ?? type()
      this.currentSelect.quoteId = cell.quoteId ?? null
      this.currentSelect.source = {}
      this.currentSelect.source.id = cell.source?.id ?? null
      this.currentSelect.source.type = cell.source?.type ?? null

      if (this.currentSelect.type === 'link') {
        this.target = cell.target
      }
      // å¯¹å˜è¿çš„æ ‡ç­¾è¿›è¡Œæ•´ç†
      if (this.currentSelect.type === 'user_transition' || this.currentSelect.type === 'quote_transition') {
        const start = cell.value.indexOf(';">') + 3
        const end = cell.value.indexOf('&nbsp;')
        if (end !== -1) {
          this.currentSelect.nodeName = cell.value.slice(start, end)
        } else {
          this.currentSelect.nodeName = cell.value
        }
      } else {
        this.currentSelect.nodeName = cell.value
      }
      this.openDrawer()
    }
    window.top['drawio']['success'] = () => {
      this.$message.success(this.$t('æ£€æµ‹æˆåŠŸ'))
    }
  },
  methods: {
    showDrawio (value) {
      this.workflowId = value
      this.axios({
        url: '/admin/workflow/initGraph',
        data: { workflowId: this.workflowId }
      }).then(res => {
        if (!res.code) {
          this.data = res.result
          // å¦‚æœè¯·æ±‚åˆ°æœ‰è¿™ä¸ªæµç¨‹å›¾,é‚£å°±è¯·æ±‚ç¼–è¾‘æ‰€
          this.lockId = Date.now() + ':' + Math.floor(Math.random() * (999 - 100 + 1) + 100)
          this.axios({
            url: '/admin/workflow/lock',
            data: {
              lockId: this.lockId,
              workflowId: this.workflowId
            }
          }).then(getLockRes => {
            if (!getLockRes.code) {
              this.show = true
              // å¦‚æœæ²¡æœ‰è¢«é”ä½,é‚£å°±å¼€å§‹æ¯éš”ä¸€åˆ†é’Ÿå°±å‘èµ·è¯·æ±‚ä¿æŒç¼–è¾‘é”
              this.keepLock = setInterval(() => {
                this.axios({
                  url: '/admin/workflow/lock',
                  data: {
                    lockId: this.lockId,
                    workflowId: this.workflowId
                  }
                })
              }, 1000 * 60)
            } else {
              // å¦‚æœè¢«é”ä½äº†,é‚£å°±å¼€å¯ç¼–è¾‘é”
              this.$error({
                title: this.$t(getLockRes.message),
                onOk () {
                }
              })
              this.lock = true
              this.show = true
            }
          })
        }
      })
      this.show = true
    },
    // ä¿å­˜æ•´ä¸ªèŠ‚ç‚¹è§†å›¾
    onSave (res) {
      if (this.lock) {
        this.$message.warning('ç¼–è¾‘é”å·²å¯ç”¨ï¼Œæ‚¨ä¸èƒ½æäº¤æ•°æ®')
        return
      }
      this.axios({
        url: '/admin/workflow/parseGraph',
        data: {
          flow: res,
          workflowId: this.workflowId
        }
      }).then(res => {
        if (!res.code) {
          this.$message.success(this.$t('ä¿å­˜æˆåŠŸ'))
        } else {
          this.$message.error(this.$t('ä¿å­˜å¤±è´¥'))
        }
      })
    },

    // æ‰“å¼€èŠ‚ç‚¹ç¼–è¾‘æ—¶è½½å…¥æ•°æ®
    openDrawer () {
      if (this.lock) {
        this.$message.warning('ç¼–è¾‘é”å·²å¯ç”¨ï¼Œæ‚¨ä¸èƒ½ç¼–è¾‘')
        return
      }
      this.axios({
        url: '/admin/workflow/getNode',
        data: {
          workflowId: this.workflowId,
          nodeId: this.currentSelect.id
        }
      }).then(res => {
        if (!res.code) {
          console.log('ğŸš€ ~ file: Drawio.vue ~ line 317 ~ openDrawer ~ this.currentSelect', this.currentSelect)
          this.currentSelect = res.result?.setting.length > 2 ? { ...JSON.parse(res.result.setting), dbId: res.result.id } : { ...this.currentSelect }
          this.$refs.FlowAttr.show({ val: this.currentSelect })
        }
      })
    },
    // æäº¤èŠ‚ç‚¹æ•°æ®ååˆ·æ–°è§†å›¾
    handleOk (val) {
      const model = this.graph.getModel()
      model.beginUpdate()
      try {
        const cells = this.graph.getEditableCells(this.graph.getSelectionCells())
        const cell = cells[0]
        let label
        // å¦‚æœæ˜¯å˜è¿,è¦æ˜¾ç¤ºæ›´å¤šä¿¡æ¯
        if (val.type === 'user_transition') {
          // if (cell.value === 'äººå·¥å˜è¿') {
          //   label = `<div id="all" style="position: relative; width: 160px; height: 100px">
          //     <div style="width:160px; position: absolute; overflow:hidden;white-space:nowrap; text-overflow:ellipsis"> æ¡ä»¶ï¼š<span class="text">${val.conditionRemarks ?? '--'}</span></div>
          //     <div style="width: 160px; overflow: hidden; position: absolute; white-space: nowrap; text-overflow: ellipsis">å­çŠ¶æ€ï¼š<span class="text">${val.processStatus ?? '--'}</span></div>
          //     <div style="width: 160px; overflow: hidden; position: absolute; white-space: nowrap; text-overflow: ellipsis">äº‹ä»¶ï¼š<span class="text">${val.remarks ?? '--'}</span></div>
          //     <hr style="border: 1px dashed #969696"/><div id="nodeName" style="width:160px; overflow:hidden; position: absolute; white-space: nowrap; text-overflow: ellipsis; ">${val.nodeName ?? '--'}&nbsp;</div>
          //     <div style="width: 160px ;overflow: hidden; position: absolute; white-space: nowrap; text-overflow: ellipsis">åŠç†äººï¼š<span id="partuserRemarks">${val.partuserRemarks ?? '--'}</span></div>
          //   </div>`
          // } else {
          const node = cell.value
          const start = node.indexOf(`<div id="all"`)
          const end = node.indexOf(`<div id="nodeName"`)
          const newNode = node.slice(start, end)
          label = newNode + `<div id="nodeName" style="width: 160px; overflow: hidden; position: absolute; white-space: nowrap; text-overflow: ellipsis ;">${val.nodeName ?? '--'}&nbsp;</div>
        <div style="width:160px; overflow: hidden; position: absolute; white-space: nowrap; text-overflow: ellipsis">åŠç†äººï¼š<span id="partuserRemarks">${val.partuserRemarks ?? '--'}</span></div></div>`
          // }
        } else if (val.type === 'link') {
          if (this.target.type === 'user_transition') {
            const node = this.target.value
            const start = node.indexOf(`<div id="nodeName"`)
            let newNode = node
            if (start !== -1) {
              newNode = node.slice(start)
            } else {
              newNode = '<div id="nodeName" style="width:100%; overflow: hidden; position: absolute; white-space: nowrap; text-overflow: ellipsis ;">' + newNode + '&nbsp;</div>'
            }
            label = ` <div id="all" style="position: relative;text-align:left;padding:10px; width: 140px;height: 100px"><div  style="width: 160px; position: absolute; overflow: hidden; white-space: nowrap; text-overflow: ellipsis"> æ¡ä»¶ï¼š<span class="text">${val.remarks1 ?? '--'}</span></div>
        <div style="width: 160px; overflow: hidden; position: absolute; white-space: nowrap; text-overflow: ellipsis">å­çŠ¶æ€ï¼š<span class="text">${val.processSubStatus ?? '--'}</span></div>
        <div style="width: 160px; overflow: hidden; position: absolute; white-space: nowrap; text-overflow: ellipsis">äº‹ä»¶ï¼š<span class="text">${val.remarks2 ?? '--'}</span></div>
        <hr style="border: 1px dashed #969696"/>` + newNode
            model.setValue(this.target, label)
          }
          return
        } else {
          label = val.nodeName
        }
        if (val.type.indexOf('gateway') !== -1 && val.type !== 'gateway_explicit') {
          model.setType(cell, val.type)
        }
        if (!model.getType()) model.setType(cell, val.type)
        model.setValue(cell, label)
        if (val.type !== 'edge') model.setName(cell, val.nodeName)
      } finally {
        model.endUpdate()
        this.graph.cellEditor.stopEditing(false)
        this.graph.refresh()
      }
      this.visible = false
    },
    handleSubmit () {
      this.form.validateFields((errors, values) => {
        if (!errors) {
          this.axios({
            url: '/admin/workflow/saveHistoryVersion',
            data: Object.assign({ workflowId: this.workflowId }, values)
          }).then(res => {
            if (res.code !== 0) {
              this.$message.success(res.message)
            }
          })
        }
      })
    },
    rollback (record) {

    }
  }
}
</script>
<style lang="less" scoped>
/deep/ .ant-drawer-body {
  height: 100%;
  overflow: hidden;
}
iframe {
  padding: 0 !important;
}
</style>
